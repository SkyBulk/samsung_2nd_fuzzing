<!doctype html>
<!--

  Author: Rosario Valotta <valotta.rosario@gmail.com>
  Date: 2013 Jan 7th 
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
 
    http://www.apache.org/licenses/LICENSE-2.0
 
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  
  Note: the fuzzer is designed to run using Grinder Framework, if you want to run it without using Grinder:
  - remove all dependencies of logger element
  - comment line 533
  - uncomment line 534
-->
<html>
	<head>
    <title>>>> Nduja Reloaded <<<</title>
	<meta http-equiv="Cache-Control" content="no-cache"/>
	<script type='text/javascript' src='logging.js'></script>
    <script type='text/javascript'>
		logger = null;
		logger = new LOGGER( "ndujaL" );
		logger.starting();
		MAXELEM=5;
		MAXPROP=3;
		MAXDESTR=3;
		MAXLISTENERS=2;
		events=['DOMActivate','DOMCharacterDataModified','DOMNodeInserted','DOMNodeInsertedIntoDocument','DOMNodeRemoved','DOMNodeRemovedFromDocument','DOMSubtreeModified','change','CheckboxStateChange','copy','cut','focus','input','load','paste','select','selectionchange','textInput','unload'];
		commands=['delete','insertButton','insertFieldset','insertHorizontalRule','insertIFrame','insertInputButton','insertInputCheckbox','insertInputFileUpload','insertInputHidden','insertInputImage','insertInputPassword','insertInputRadio','insertInputReset','insertInputSubmit','insertInputText','insertMarquee','insertOrderedList','insertSelectDropdown','insertSelectListbox','insertTextArea','insertUnorderedList'];
		interesting_vals = [0, 1, 5e6, -7e6, 8e-6, 2e100, null, 'pink', false, true, 7500000000, 4400000000, -4400000000, -7500000000];
		object_blacklist = [
		  'nodeName',
		  'nodeValue',
		  'nodeType',
		  'childNodes',
		  'location',
		  'name',
		  'opener',
		  'URL',
		  'onbeforeunload',
		  'onunload',
		  'innerHTML',
		  'outerHTML',
		  'innerText',
		  'textContent',
		  'Components',
		  'controllers',
		  'lastChild',
		  'previousSibling',
		  'previousElementSibling',
		  'parentNode',
		  'parentTextEdit',
		  'parentElement',
		  'ownerDocument',
		  'document' ,
		  'cloneNode',
		  'open',
		  'close',
		  'print'
		];
	
		
		styles= [
		['background-attachment','fixed','scroll'],
		['background-color','#b0c4de','none'],
		['background-image','file:///c:/grinder/node/data/grind.jpg'],
		['background-position','size','50% 50%','10 10','left top','center top','inherit'],
		['background-repeat','repeat','repeat-x','repeat-y','no-repeat'],
		['border','solid','double','groove','dotted','dashed','inset','outset','ridge','hidden','four-sides','5px'],
		['border-bottom','5px','#b0c4de','thick'],
		['border-bottom-color','#b0c4de'],
		['border-bottom-style','solid','double','groove','dotted','dashed','inset','outset','ridge','hidden'],
		['border-bottom-width','5px','thick'],
		['border-color','#b0c4de'],
		['border-left','10px','#ff0000','thin'],
		['border-left-color','#ff0000'],
		['border-left-style','solid','double','groove','dotted','dashed','inset','outset','ridge','hidden'],
		['border-left-width','10px','thin'],
		['border-right','5px','#b0c4de','thin'],
		['border-right-color','#b0c4de'],
		['border-right-style','solid','double','groove','dotted','dashed','inset','outset','ridge','hidden'],
		['border-right-width','5px','thin'],
		['border-style','solid','double','groove','dotted','dashed','inset','outset','ridge','hidden','four-sides','thick'],
		['border-top','5px','#b0c4de','thick'],
		['border-top-color','#b0c4de'],
		['border-top-style','solid','double','groove','dotted','dashed','inset','outset','ridge','hidden'],
		['border-top-width','5px','thick'],
		['border-width','5px','thick'],
		['clear','left','right','both'],
		['color','#b0c4de'],
		['display','block','inline'],
		['float','left','right'],
		['font-family','Georgia'],
		['font-size','100%','10px','small','inherit'],
		['font-style','italic','oblique','normal'],
		['font-variant','small-caps'],
		['font-weight','bold','900'],
		['height','100px','auto'],
		['letter-spacing','2px'],
		['line-height','2','90%'],
		['list-style','circle','square','disc','upper-alpha','lower-alpha','upper-roman','lower-roman','decimal','inside','outside','none'],
		['list-style-image','file:///c:/grinder/fuzzer/background.jpg'],
		['list-style-position','inside','outside'],
		['list-style-type','circle','square','disc','upper-alpha','lower-alpha','upper-roman','lower-roman','decimal'],
		['margin','5px','10%','auto'],
		['margin-bottom','2px','30%','auto'],
		['margin-left','5px','50%','auto'],
		['margin-right','5px','50%','auto'],
		['margin-top','10px','60%','auto'],
		['padding','5px','100%','four-sides'],
		['padding-bottom','10px','100%'],
		['padding-left','5px','40%'],	
		['padding-right','6px','100%'],
		['padding-top','10px','40%'],
		['position','absolute','relative','100%','100px'],
		['text-align','right','center','left','justify'],
		['text-decoration','line-through','overline','underline','none'],
		['text-indent','5px','5%'],
		['text-transform','capitalize','lowercase','uppercase'],
		['vertical-align','vertical-values'],
		['white-space','nowrap'],
		['width','100pz','100%','auto'],
		['word-spacing','2px'],
		['z-index','1']];
		

		elements = [
		  "CANVAS",
		  "ARTICLE",
		  "ASISE",
		  "B",
		  "BDI",
		  "BDO",
		  "BLOCKQUOTE",
		  "BR",
		  "BUTTON",
		  "CANVAS",
		  "CAPTION",
		  "CITE",
		  "COL",
		  "CODE",
		  "COMMAND",
		  "DATALIST",
		  "DD",
		  "DEL",
		  "DETAILS",
		  "DFN",
		  "DL",
		  "DT",
		  "EM",
		  "STYLE",
		  "FIELDSET",
		  "FIGCAPTION",
		  "SCRIPT",
		  "EMBED",
		  "FIGURE",
		  "FOOTER",
		  "HEADER",
		  "HGROUP",
		  "HR",
		  "I",
		  "INPUT",
		  "INS",
		  "KEYGEN",
		  "KBD",
		  "LEGEND",
		  "MARK",
		  "MENU",
		  "METER",
		  "NAV",
		  "NOSCRIPT",
		  "OPTGROUP",
		  "OUTPUT",
		  "P",
		  "PARAM",
		  "PRE",
		  "PROGRESS",
		  "Q",
		  "RP",
		  "RT",
		  "RUBY",
		  "S",
		  "SAMP",
		  "SECTION",
		  "SELECT",
		  "SMALL",
		  "SOURCE",
		  "SPAN",
		  "SUP",
		  "TH",
		  "THEAD",
		  "TIME",
		  "OBJECT",
		  "IFRAME",
		  "TEXTAREA",
		  "TRACK",
		  "U",
		  "VAR",
		  "WBR",
		  "FORM",
		  "A",
		  "BODY",
		  "HTML",
		  "DIV",
		  "TABLE",
		  "AREA",
		  "TD",
		  "TR",
		  "LINK",
		  "BASE",
		  "FONT",
		  "HEAD",
		  "IMG",
		  "MAP",
		  "META",
		  "OL",
		  "LI",
		  "TBODY",
		  "TITLE",
		  "H1",
		  "BLINK",
		 // "!DOCTYPE",
		  "AREA",
		  "COL",
		  "SPAN",
		  "FRAMESET",
		  "FRAME",
		  "UL",
		  "OPTION",
		  "NOFRAMES",
		  "TFOOT",
		  "XMP",
		  "ISINDEX",
		  "CENTER",
		  "HR",
		  "LABEL",
		  "OPTGROUP",
		  "AUDIO",
		  "VIDEO",
		  "SVG"
		];
			
		
		
		
		/*****************************************
		* Generate random integer (0 ... mod-1) *
		*****************************************/

		function R(mod) {
		  return rand(10000) % mod;
		}
		
		function RBool(){
			r=R(2);
			//alert(r);
			if (r==0) {return true;}
			else {return false;}
		}
		
		function initialize(elem){
			
			try{
				currElem=findInTree(elem);

				for (z=0;z<MAXLISTENERS;z++){	
					
					ri=rand_item(events);
					//alert(r);
					rndb=RBool();
					elem.addEventListener (ri, modifyDOM, rndb);	
					logger.log('//added ' + ri + ' listener to '+elem,"ndujaL",1);
					logger.log('elementTree1['+currElem+'].addEventListener("'+ri+'",modifyDOM,'+rndb+');','ndujaL',1);

				}
			}	
			catch (exception) { 
				logger.log("//**************Exception in listener initialization*************","ndujaL",1);
			}
		}
		
		function removeListeners(elem){
				try{
					currElem=findInTree(elem);

					for (z=0;z<MAXLISTENERS;z++){	
					
					ri=rand_item(events);
					rndb=RBool();
					//alert(r);
					elem.removeEventListener (ri, modifyDOM, rndb);	
					logger.log('//removed ' + ri + ' listeners to '+elem,"ndujaL",1);
					logger.log('elementTree1['+currElem+'].removeEventListener("'+ri+'",modifyDOM,'+rndb+');','ndujaL',1);


					}

				}
				catch (exception) { 
					logger.log("//******************Exception in remove listeners****************","ndujaL",1);
				}
		}
		
		function findInTree(elem){
			k=-1;j=0;
			found=false;
			while ((j<document.all.length)&&(!found)){
				if (elem==elementTree1[j]) {
					k=j;
					found=true;
				}	
				j++;
			}
			return k;
		}
		
		function modifyDOM(event){
			
                switch (event.eventPhase) {
                case Event.CAPTURING_PHASE:
					logger.log("//INIZIO CAPTURE**********event "+event.type+" captured","ndujaL",1);
					logger.log("//Inizio rimozione listener su nodo corrente","ndujaL",1);
					//logger.log("//elementTree1["+currElem+"]","ndujaL",1);
					removeListeners(event.currentTarget);
					switch (R(4)){
						case 0:
							logger.log("//Inizio creazione Range ","ndujaL",1);
							createElemRange();
							logger.log("//inizio alterRange","ndujaL",1);
							alterRange();
							logger.log("//Fine alter Range ","ndujaL",1);
							break;
						case 1:
							logger.log("//Inizio creazione TXTRange ","ndujaL",1);
							createTxtRange();
							logger.log("//inizio alterTextRange","ndujaL",1);
							alterTextRange();
							logger.log("//Fine alterTextRange ","ndujaL",1);
							break;
						case 2:
							logger.log("//Inizio creazione Range ","ndujaL",1);
							createElemRange();
							logger.log("//inizio alterRange","ndujaL",1);
							alterRange();
							logger.log("//Fine alter Range ","ndujaL",1);
							logger.log("//Inizio move iteration ","ndujaL",1);
							moveIterator();
							logger.log("//Fine move iteration ","ndujaL",1);
							break;
						case 3:
							logger.log("//Inizio creazione TXTRange ","ndujaL",1);
							createTxtRange();
							logger.log("//inizio alterTextRange","ndujaL",1);
							alterTextRange();
							logger.log("//Fine alterTextRange ","ndujaL",1);
							logger.log("//Inizio move tw ","ndujaL",1);
							moveTreeWalker();
							logger.log("//Fine move tw","ndujaL",1);
							break;	
					}
					
					
					

					switch (R(4)){
						case 0:
							logger.log("//Inizio move iteration ","ndujaL",1);
							moveIterator();
							logger.log("//Fine move iteration ","ndujaL",1);
						break;
						case 1:
							logger.log("//Inizio insert subtree","ndujaL",1);
							insertSubTree();	
							logger.log("//Fine insert subtree","ndujaL",1);
						break;
						case 2:
							logger.log("//Inizio tree crawl","ndujaL",1);
							treeCrawler1();
							logger.log("//Fine tree crawl","ndujaL",1);

						break;
						case 3:
							logger.log("//Inizio move tw ","ndujaL",1);
							moveTreeWalker();
							logger.log("//Fine move tw","ndujaL",1);
						break;

					}	
					spray();
					logger.log("spray();","ndujaL",1);
					logger.log("//Fine capture phase "+event.type+" su elemento corrente:"+event.currentTarget+"","ndujaL",1);

                    break;
                case Event.AT_TARGET:
					logger.log("//Inizio At Target su elemento target:"+event.target+"","ndujaL",1);
					currElem=findInTree(event.target);
					logger.log("//elementTree1["+currElem+"]","ndujaL",1);
					initialize(event.target);
					logger.log("//Fine At Target su elemento target:"+event.target+"","ndujaL",1);

                    break;
                case Event.BUBBLING_PHASE:
					logger.log("//INIZIO BuBLE**********event "+event.type+" captured","ndujaL",1);
					logger.log("//Inizio bubbling su elemento corrente","ndujaL",1);
					logger.log("//Inizio rimuovo listener su elemento corrente","ndujaL",1);
					currElem=findInTree(event.currentTarget);
					logger.log("//elementTree1["+currElem+"]","ndujaL",1);
					removeListeners(event.currentTarget);
						switch (R(4)){
						case 0:
							logger.log("//Inizio creazione Range ","ndujaL",1);
							createElemRange();
							logger.log("//inizio alterRange","ndujaL",1);
							alterRange();
							logger.log("//Fine alter Range ","ndujaL",1);
							break;
						case 1:
							logger.log("//Inizio creazione TXTRange ","ndujaL",1);
							createTxtRange();
							logger.log("//inizio alterTextRange","ndujaL",1);
							alterTextRange();
							logger.log("//Fine alterTextRange ","ndujaL",1);
							break;
						case 2:
							logger.log("//Inizio creazione Range ","ndujaL",1);
							createElemRange();
							logger.log("//inizio alterRange","ndujaL",1);
							alterRange();
							logger.log("//Fine alter Range ","ndujaL",1);
							logger.log("//Inizio creazione TXTRange ","ndujaL",1);
							createTxtRange();
							logger.log("//inizio alterTextRange","ndujaL",1);
							alterTextRange();
							logger.log("//Fine alterTextRange ","ndujaL",1);
							break;
						case 3:
							logger.log("//Inizio creazione TXTRange ","ndujaL",1);
							createTxtRange();
							logger.log("//inizio alterTextRange","ndujaL",1);
							alterTextRange();
							logger.log("//Fine alterTextRange ","ndujaL",1);
							logger.log("//Inizio creazione Range ","ndujaL",1);
							createElemRange();
							logger.log("//inizio alterRange","ndujaL",1);
							alterRange();
							logger.log("//Fine alter Range ","ndujaL",1);
							break;	
					}
									
					switch (R(4)){
						case 0:
							logger.log("//Inizio move iteration ","ndujaL",1);
							moveIterator();
							logger.log("//Fine move iteration ","ndujaL",1);
						break;
						case 1:
							logger.log("//Inizio insert subtree","ndujaL",1);
							insertSubTree();	
							logger.log("//Fine insert subtree","ndujaL",1);
						break;
						case 2:
							logger.log("//Inizio tree crawl","ndujaL",1);
							treeCrawler1();
							logger.log("//Fine tree crawl","ndujaL",1);

						break;
						case 3:
							logger.log("//Inizio move tw ","ndujaL",1);
							moveTreeWalker();
							logger.log("//Fine move tw","ndujaL",1);
						break;

					}
					logger.log("//Inizio inizialize dopo bubble phase "+event.type+"  su elemento corrente:"+event.currentTarget+"","ndujaL",1);
					initialize(event.target);					
					logger.log("//Fine bubble phase "+event.type+"  su elemento corrente:"+event.currentTarget+"","ndujaL",1);

					break;
                }
            
        }
			
		function insertSubTree(){
            try{    
				logger.log("//inizio insert subtree************","ndujaL",1);

				elementTree2=[];
				logger.log("elementTree2=[];","ndujaL",1);
				for (h=0;h<MAXELEM;h++){
					
					r=rand_item( elements );
					elementTree2[h]=document.createElement(r);
					//alert(r);
					logger.log("elementTree2["+h+"]=document.createElement('"+r+"');","ndujaL",1);
					rb=R(document.all.length);
					document.all[rb].appendChild(elementTree2[h]);
					logger.log( "document.all["+rb+"].appendChild(elementTree2["+h+"]);", "ndujaL", 1 );
					//eventManage(elementTree2[j],j);
					
				}	
				//alert("subtree");

            }
			catch (exception) {
				logger.log("//Exception in subtree insertion","ndujaL",1);

			}	
		
		}
		
	
		function step1()
		{
			//create document tree
			logger.log("//Start buildDoc from Step1","nduja10",1);
			buildElementsTree1();
			logger.log("//Finish buildDoc from Step1","nduja10",1);
			logger.log("//Start initialize from Step1","nduja10",1);
			initialize();
			logger.log("//Finish initialize from Step1","nduja10",1);
			boom();
			
			logger.finished();
			window.location.href = window.location.protocol + '//' + window.location.host + '/nduja11.html';
			//window.location.href = "file:///C:/grinder/node/fuzzer/nduja11.html";
		}
				
			
		function buildDoc1(){
			
			buildElementsTree1();
			//createIterator1();
			//createTagAggregation1();
		}
		
		function createTxtRange(){
			try{
				logger.log("range2 = document.body.createTextRange();","ndujaL",1);
				range2 = document.body.createTextRange();
				r2=R(document.body.all.length);
				logger.log("startNode=document.body.all["+r2+"];","ndujaL",1);
				startNode=document.body.all[r2];
				logger.log("range2.moveToElementText(startNode);","ndujaL",1);
				range2.moveToElementText(startNode);
				shift=R(20);			
				logger.log("range2.moveEnd('character',"+ shift+"); ","ndujaL",1);
				range2.moveEnd("character", shift);  

			}	
			catch (exception) {
					logger.log( "//Error in creating textrange  in document ", "ndujaL", 1  );
			}
		}
		
		function createElemRange1(){
			try{
				range1 = document.createRange();
				logger.log("range1 = document.createRange();","ndujaL",1);
				r1=R(document.all.length);
				startNode=document.all[r1];
				logger.log("startNode=document.all["+r1+"];","ndujaL",1);
				range1.setStart(startNode, 0);
				logger.log("range1.setStart(startNode, 0);","ndujaL",1);
				r2=R(document.all.length);
				endNode=document.all[r2];
				logger.log("endNode=document.all["+r2+"];","ndujaL",1);
				range1.setEnd(endNode, 0);
				logger.log("range1.setEnd(endNode,0);","ndujaL",1);
				//alert("range created");
			}
			catch (exception) {
					logger.log( "//Error in creating range1  in document ", "ndujaL", 1  );
			}
		}
		
		function createElemRange(){
			try{
				range = document.createRange();
				logger.log("range = document.createRange();","ndujaL",1);
				r1=R(document.all.length);
				startNode=document.all[r1];
				logger.log("startNode=document.all["+r1+"];","ndujaL",1);
				range.setStart(startNode, 0);
				logger.log("range.setStart(startNode, 0);","ndujaL",1);
				r2=R(document.all.length);
				endNode=document.all[r2];
				logger.log("endNode=document.all["+r2+"];","ndujaL",1);
				range.setEnd(endNode, 0);
				logger.log("range.setEnd(endNode,0);","ndujaL",1);
				
			}
			catch (exception) {
					logger.log( "//Error in creating range  in document ", "ndujaL", 1  );
			}
		}

		
		function createTagAggregation1(){
				try{
				index=R(elementTree1.length);
				tagAggregation1 = document.getElementsByTagName(elementTree1[index].tagName);
				logger.log("tagAggregation1 = document.getElementsByTagName('"+elementTree1[index].tagName+"');","ndujaL",1);
				}
				catch (exception) {
					logger.log( "//Error in creating tag aggregation in document", "ndujaL", 1  );
				}
		}

		function createTreeWalker(){
			 try{
				rb=R(document.all.length);
				logger.log("randRoot=document.all["+rb+"];","ndujaL",1);
				randRoot=document.all[rb];
				logger.log("ni= document.createTreeWalker(document.all[0], NodeFilter.SHOW_ALL, ElementChecker, false);","ndujaL",1);
				ni = document.createTreeWalker(document.all[randRoot], NodeFilter.SHOW_ALL, ElementChecker, false);
				}
				catch (exception) {
					logger.log( "//Errorin creating tree walker in document ", "ndujaL", 1  );
				}
		
		}
		function createNodeIterator(){
			 try{
				rb=R(document.all.length);
				logger.log("randRoot=document.all["+rb+"];","ndujaL",1);
				randRoot=document.all[rb];
				logger.log("ni= document.createNodeIterator(document.all[0], NodeFilter.SHOW_ALL, ElementChecker, false);","ndujaL",1);
				ni = document.createNodeIterator(document.all[randRoot], NodeFilter.SHOW_ALL, ElementChecker, false);
				}
				catch (exception) {
					logger.log( "//Errorin creating iterator in document ", "ndujaL", 1  );
				}
		
		}
		
		 function ElementChecker() {
            try{
				switch (R(2)){
					case 0:
						//alert(1);
						logger.log("//inizio creazione range dentro Element CHecker","ndujaL",1);
						logger.log("createElemRange1();","ndujaL",1);
						createElemRange1();
						//alert(2);
						deleteRange1();
						//alert(3);
						logger.log("//finisco creazione range dentro Element CHecker","ndujaL",1);

						break;
					case 1:
						break;
				}
				switch (R(2)){	
					case 0:
						return NodeFilter.FILTER_ACCEPT;
						break;
					case 1:
						return NodeFilter.FILTER_SKIP;
						break;
				}
			}	
			catch (exception) {
						logger.log( "//Errorin node filter ", "ndujaL", 1  );
						return NodeFilter.FILTER_ACCEPT;
			}			
		}
                
         
            
       
	
	
		function buildElementsTree1(){
			try{
				elementTree1=[];
				//clobber=[];
				logger.log("elementTree1=[];","ndujaL",1);
				if(document.createStyleSheet){
					styleSheet1 = document.createStyleSheet ("");
					logger.log('styleSheet1 = document.createStyleSheet ("");',"ndujaL",1);
				}
				else { 
					styleSheet1=document.createElement('link'); 
					styleSheet1.rel='stylesheet'; 
					document.body.appendChild(styleSheet1); 
				} 
				for (k=0;k<MAXELEM;k++){
					
					r=rand_item( elements );
					elementTree1[k]=document.createElement(r);
					logger.log("elementTree1["+k+"]=document.createElement('"+r+"');","ndujaL",1);
					//assegno un id x clobbering
					elementTree1[k].id="el"+k;
					logger.log("elementTree1["+k+"].id='el"+k+"';","ndujaL",1);
					
					rb=R(document.all.length);
					document.all[rb].appendChild(elementTree1[k]);
					logger.log( "document.all["+rb+"].appendChild(elementTree1["+k+"]);", "ndujaL", 1 );
					initialize(elementTree1[k]);
					tweakattributes1(elementTree1[k],k);
					tweakstyle1(elementTree1[k],k);
				}
			}
			catch (exception) {
					logger.log( "//Error in creating element tree in document ", "ndujaL", 1  );
			}
		}
		
		function tweakElem(elem){
			for( var p in elem){
				try {
					
							r=rand_item(interesting_vals);
							elem.setAttribute(p,r);
							logger.log(""+elem.tagName+"."+p+"="+r+";", "ndujaL", 1  );
				
					}
					
				
				catch (exception) {
					logger.log( "//Error in tweaking  document element "+elem.tagName+"."+p+"", "ndujaL", 1  );
				}
			}
		}
		
		function tweakattributes1(elem,i){
			logger.log( "//Start tweaking attributes for elementTree1["+i+"]", "ndujaL", 1  );
			for( var p in elem){
				try {
					
							r=rand_item(interesting_vals);
							logger.log( "elementTree1["+i+"]."+p+"="+r+";", "ndujaL", 1  );
							elem.setAttribute(p,r);

				
					}
					
				
				catch (exception) {
					logger.log( "//Error in tweaking  document element "+elementTree1[i]+"."+p+"", "ndujaL", 1  );
				}
			}
		}
		function tweakattributes(elem){
				for( var p in elem){
					try {
						elem.setAttribute(p,"\u4545\u4545\u4545\u4545\u4545\u4545\u4545\u4545\u4545\u4545\u4545\u4545\u4545");
					}
						catch (exception) {
					}
				}
			}			

		function tweakstyle1 (elem,i){
			for(j=0; j<MAXPROP;j++){
				try {
					prop=styles[R(styles.length)];
					propL=prop.length;
					propName=prop[0];
					valueIndex=R(propL);
					propValue=prop[valueIndex];
					styleSheet1.addRule(elementTree1[i].tagName,"{"+propName+": "+propValue+";}");
					logger.log( "styleSheet1.addRule(elementTree1["+i+"].tagName,'{"+propName+": "+propValue+";}');", "ndujaL", 1  );
				}
				catch (exception) {
					logger.log( "//Errorin tweaking style for elementTree1["+i+"]", "ndujaL", 1  );
				}
			}
		}	
			
		function deleteRange1(){
			try{
				
				logger.log("range1.deleteContents();","ndujaL",1);
				range1.deleteContents();
			}
			catch (exception) {
				logger.log( "//Error in deleting range1", "ndujaL", 1  );
			}
		}
	
	
		function destroy1(node){
			try {
				node=null;
				logger.log( "randomNode1=null;","ndujaL",1 );
				
			  }
			catch (exception) {
				logger.log( "//Exception in destroying "+randomNode1+" from document, destroyed node ","ndujaL",1 );
			  }
		}	


		function boom(){	
			
				try
				{
					logger.log("//start boom","ndujaL",1);
					createNodeIterator();
					createTreeWalker();
					createTagAggregation1();
					createElemRange();
					createTxtRange();					
					alterRange();
					logger.log("spray();","ndujaL",1);
					spray();
					moveIterator();
					moveTreeWalker();
					tagCrawler1();
					logger.log("//end boom","ndujaL",1);
					
				}
				catch( exception )
				{
					logger.log( "//Exception in boom function","ndujaL",1 );
				}
					
		}
		
		function alterRange(){
			try{
				cmd=rand(11);
				rb=R(document.all.length);//va ristretto alla length del range
				randElem=document.all[rb];
				logger.log( "randElem=document.all["+rb+"];","ndujaL",1 );
				switch (cmd){
					case 0:
						logger.log( "range.deleteContents();","ndujaL",1 );
						range.deleteContents();
						break;
					case 1:
						logger.log( "range.collapse();","ndujaL",1 );
						range.collapse();
						break;
					case 2:
						logger.log( "var documentFragment = range.extractContents();","ndujaL",1 );
						var documentFragment = range.extractContents();
						break;
					case 3:
						logger.log( "range.surroundContents(randElem);","ndujaL",1 );
						range.surroundContents(randElem);
						break;
					case 4:	
						logger.log( "range.selectNode(randElem);","ndujaL",1 );
						range.selectNode(randElem);
						break;
					case 5:
						logger.log( "range.selectNodeContents(randElem);","ndujaL",1 );
						range.selectNodeContents(randElem);
						break;
					case 6:
						logger.log( "range.insertNode(randElem);","ndujaL",1 );
						range.insertNode(randElem);
						break;
					case 7:
						logger.log( "range.setStartAfter(randElem);","ndujaL",1 );
						range.setStartAfter(randElem);
						break;
					case 8:
						logger.log( "range.setStartBefore(randElem);","ndujaL",1 );
						range.setStartBefore(randElem);
						break;
					case 9:
						logger.log( "range.setEndAfter(randElem);","ndujaL",1 );
						range.setEndAfter(randElem);
						break;						
					case 10:
						logger.log( "range.setEndBefore(randElem);","ndujaL",1 );
						range.setEndBefore(randElem);
						break;
				}		
				
								
			}
			catch( exception )
			{
					logger.log( "//Exception in alterRange function","ndujaL",1 );
			}
			
		}
		
		function alterTextRange(){
			try{
				cmd=R(commands.length);
				//alert(cmd)
				logger.log( "range2.select();","ndujaL",1 );
				range2.select();
				logger.log( "range2.execCommand('"+commands[cmd]+"',true,null);","ndujaL",1 );
				range2.execCommand(commands[cmd],true,null);
			
			}
			catch( exception )
			{
					logger.log( "//Exception in alterTextRange function","ndujaL",1 );
			}
		}
		
		function rulesCrawler1(){
			try{
				l=styleSheet1.cssRules.length;	
				for (i=0;i<l;i++){
					
					styleSheet1.cssRules[i].style.setAttribute('color','red');
					logger.log("styleSheet1.cssRules["+i+"].style.setAttribute('color','red');", "ndujaL",1);
				}	

			}
			catch (exception) {
				logger.log( "//Exception in rules crawling style in document for"+styleSheet1.cssRules["+i+"].cssText,"ndujaL",1 );

			}
		}
	
		function moveIterator(){
			try{
				rMoves=R(5);
				for (i=0; i<rMoves; i++){
				
					rm=R(2);
					switch(rm){
						case 0:
							logger.log( "ni.nextNode();","ndujaL",1 );
							ni.nextNode();
							break;
						case 1:
							logger.log( "ni.previousNode();","ndujaL",1 );
							ni.previousNode();
							break;
					
					}
				}	
				fuzzAttributes(-1,"it1");
			
			}
			catch (exception) {
				logger.log( "//Exception in moveIteration ","ndujaL",1 );
			}
		}


		function moveTreeWalker(){
			try{
				rMoves=R(5);
				for (i=0; i<rMoves; i++){
				
					rm=R(7);
					switch(rm){
						case 0:
							logger.log( "tw.nextNode();","ndujaL",1 );
							tw.nextNode();
							break;
						case 1:
							logger.log( "tw.previousNode();","ndujaL",1 );
							tw.previousNode();
							break;
						case 2:
							logger.log( "tw.previousSibling();","ndujaL",1 );
							tw.previousSibling();
							break;
						case 3:
							logger.log( "tw.nextSibling();","ndujaL",1 );
							tw.nextSibling();
							break;
						case 4:
							logger.log( "tw.firstChild();","ndujaL",1 );
							tw.firstChild();
							break;
						case 5:
							logger.log( "tw.lastChild();","ndujaL",1 );
							tw.lastChild();
							break;
						case 6:
							logger.log( "tw.parentNode();","ndujaL",1 );
							tw.parentNode();
							break;	
					}
				}	
				fuzzAttributes(-1,"tw");
			
			}
			catch (exception) {
				logger.log( "//Exception in moveTreeWalker ","ndujaL",1 );
			}
		}		
		
		function nodeIteration1(){
			try{
				current = ni.root;
				logger.log('current = ni.root;',"ndujaL",1);
				
				for (var p in ni1) {
					fuzzAttributes(-1,"it1");
					logger.log('current = ni1.nextNode();',"ndujaL",1);
					current = p;//ni1.nextNode();

					//alert(current);
				}
			}
			catch (exception) {
				logger.log( "//Exception in BOOM - node iteration in document at node"+current+"","ndujaL",1 );
			}
		}
	
	

		function treeCrawler1(){
			try{
				l=elementTree1.length;	
				for (i=0;i<l;i++){
					logger.log("elementTree1["+i+"].normalize();","ndujaL",1);
					elementTree1[i].normalize();
					fuzzAttributes(i,"tree1");
				}	

			}
			catch (exception) {
				logger.log( "//Exception in tree crawling  for document"+elementTree1[i],"ndujaL",1 );

			}
		}
	
		function tagCrawler1(){
			try{
					l=tagAggregation1.length;	
					for (i=0;i<l;i++){
						fuzzAttributes(i, "tag1");
					}	

				}
				catch (exception) {
					logger.log( "//Exception in tags crawling in document for"+tagAggregation1[i],"ndujaL",1 );

				}
		}
	
		function nodeIteration(){
			try{
				logger.log('currentNode = ni.root;',"nduja10",1);
				currentNode = ni.root;
	
                while (currentNode!=range.startContainer)  {
					if (currentNode!=range.startContainer){
						currentNode = ni.nextNode();
						
					}
                }
				
			}
			catch (exception) {
				logger.log( "//Exception in nodeiteration in document at node "+currentNode+"","nduja10",1 );
			}
		}
	
		function treeIteration(){
			try{
				logger.log('currentLeaf = tw.root;',"nduja10",1);
				currentLeaf = tw.root;
			
                while (currentLeaf!=range.startContainer)  {
					if (currentLeaf!=range.startContainer){
						currentLeaf = tw.nextNode();
						
					}
                }
				
			}
			catch (exception) {
				logger.log( "//Exception in treeIteration in document at leaf "+currentLeaf+"","nduja10",1 );
			}
		}
		function fuzzAttributes(index,orig){
			for( var i=0 ; i<object_blacklist.length ; i++ )
			{
					
					try
					{
						var prop = object_blacklist[i];
						
						c=rand(6);
				
						switch( c )
						{
							
							case 0:
								try{
									if (orig=="tree1"){
										logger.log( "eval('elementTree1["+index+"]." + prop + "= null');", "ndujaL",1);

										eval("elementTree1["+index+"]."+prop+" = null");
										
										logger.log( "eval('document.el"+index+"." + prop + "= null');", "ndujaL",1);

										eval("document.el"+index+"."+prop+" = null");
									}
									
									if (orig=="tag1"){
										logger.log( "eval('tagAggregation1["+index+"]." + prop + "= null');", "ndujaL",1);
										eval("tagAggregation1["+index+"]."+prop+" = null");

									}
									
									if ((orig=="it1") || (orig=="it2")){
										logger.log( "eval('currentNode." + prop + "= null');", "ndujaL",1);
										eval("currentNode."+prop+" = null");

										
									}
									if (orig=="tw"){
										logger.log( "eval('currentLeaf." + prop + "= null');", "ndujaL",1);
										eval("currentLeaf."+prop+" = null");

										
									}
								}
								catch (exception){}		
								break;
							// Perhaps we can call this (we have performed no validation if propA is for a function of not)
							case 1:
								try{
									if (orig=="tree1"){
										logger.log("eval('elementTree1["+index+"]."+prop+"()')", "ndujaL",1 );
										eval("elementTree1["+index+"]."+prop+"()");
										logger.log( "eval('document.el"+index+"." + prop + "()');", "ndujaL",1);

										eval("document.el"+index+"."+prop+"()");

									}	
									
									if (orig=="tag1"){
										logger.log("eval('tagAggregator1["+index+"]."+prop+"()')", "ndujaL",1 );
										eval("tagAggregator1["+index+"]."+prop+"()");

									}
									
									if ((orig=="it1") || (orig=="it2")){
										logger.log("eval('currentNode."+prop+"()')", "ndujaL",1 );
										eval("currentNode."+prop+"()");
										
									}
									if (orig=="tw"){
										logger.log("eval('currentLeaf."+prop+"()')", "ndujaL",1 );
										eval("currentLeaf."+prop+"()");
										
									}
								}
								catch (exception){}								
								break;
							// Perform a call and pass in object A as a parameter...
							case 2:
								try{
									if (orig=="tree1"){
										logger.log( "eval('elementTree1["+index+"]."+prop+"(elementTree1["+index+"].parentNode)');", "ndujaL",1 );
										eval("elementTree1["+index+"]."+prop+"(elementTree1["+index+"].parentNode);");
										logger.log( "eval('document.el"+index+"." + prop +"(document.el"+index+".parentNode)');", "ndujaL",1 );
										eval("document.el"+index+"."+prop+"(document.el"+index+".parentNode");
										
									}
									
									if (orig=="tag1"){
										logger.log( "eval('tagAggregator1["+index+"]."+prop+"(tagAggregator1["+index+"].parentNode)');", "ndujaL",1 );
										eval("tagAggregator1["+index+"]."+prop+"(tagAggregator1.["+index+"].parentNode);");
										
									}
									
									if ((orig=="it1") || (orig=="it2")){
										logger.log( "eval('currentNode."+prop+"(currentNode.parentNode)');", "ndujaL",1 );
										eval("currentNode."+prop+"(currentNode.parentNode);");

									}
									if (orig=="tw") {
										logger.log( "eval('currentLeaf."+prop+"(currentLeaf.parentNode)');", "ndujaL",1 );
										eval("currentLeaf."+prop+"(currentLeaf.parentNode);");

									}
								}
								catch (exception){}		
								break;
							// Set some value from one object to the value of another (although we havent verified if the other property even exists)...
							case 3:
								try{
									if (orig=="tree1"){
										logger.log( "eval('elementTree1["+index+"]."+prop+"=elementTree1["+index+"].parentNode."+prop+"');", "ndujaL",1 );
										eval("elementTree1["+index+"]."+prop+"=elementTree1["+index+"].parentNode."+prop+"");
										logger.log( "eval('document.el"+index+"." + prop +"(document.el"+index+".parentNode."+prop+")');", "ndujaL",1 );
										eval("document.el"+index+"."+prop+"(document.el"+index+".parentNode."+prop);
									}
									
									if (orig=="tag1"){
										logger.log( "eval('tagAggregator1["+index+"]."+prop+"=tagAggregator1["+index+"].parentNode."+prop+"');", "ndujaL",1 );
										eval("tagAggregator1["+index+"]."+prop+"=tagAggregator1["+index+"].parentNode."+prop+"");
										
									}
									
									if ((orig=="it1") || (orig=="it2")){
										logger.log( "eval('currentNode."+prop+"=currentNode.parentNode."+prop+"');", "ndujaL",1 );
										eval("currentNode."+prop+"=currentNode.parentNode."+prop+"");
										
									}
									if (orig=="tw") {
										logger.log( "eval('currentLeaf."+prop+"=currentLeaf.parentNode."+prop+"');", "ndujaL",1 );
										eval("currentLeaf."+prop+"=currentLeaf.parentNode."+prop+"");
										
									}
								}
								catch (exception){}								
								break;
							case 4:
								try{
									var r=rand(interesting_vals.length);
									var rv=interesting_vals[r];
									
									if (orig=="tree1"){
										logger.log( "eval('elementTree1["+index+"]." + prop + " = "+rv+"');", "ndujaL",1 );
										eval("elementTree1["+index+"]." + prop + " = "+rv+"");
										logger.log( "eval('document.el"+index+"." + prop + " = "+rv+"');", "ndujaL",1 );
										eval("document.el"+index+"." + prop + " = "+rv+"");
										
									}
									
									if (orig=="tag1"){
										logger.log( "eval('tagAggregator1["+index+"]." + prop + " = "+rv+"');", "ndujaL",1 );
										eval("tagAggregator1["+index+"]." + prop + " = "+rv+"");

									}
									
									if ((orig=="it1") || (orig=="it2")){
										logger.log( "eval('currentNode." + prop + " = "+rv+"');", "ndujaL",1 );
										eval("currentNode." + prop + " = "+rv+"");
										
										
									}
									if (orig=="tw") {
										logger.log( "eval('currentLeaf." + prop + " = "+rv+"');", "ndujaL",1 );
										eval("currentLeaf." + prop + " = "+rv+"");
										
										
									}
								}
								catch (exception){}
								break;
							case 5:
								try{
									var r=rand(interesting_vals.length);
									var rv=interesting_vals[r];
									
									if (orig=="tree1"){
										logger.log( "eval('elementTree1["+index+"]."+ prop + "("+rv+")');", "ndujaL",1 );
										eval("elementTree1["+index+"]."+ prop + "("+rv+")");
										logger.log( "eval('document.el"+index+"." + prop + " ( "+rv+")');", "ndujaL",1 );
										eval("document.el"+index+"." + prop + " ("+rv+")");
										
									}	
									
									if (orig=="tag1"){
										logger.log( "eval('tagAggregator1["+index+"]."+ prop + "("+rv+")');", "ndujaL",1 );
										eval("tagAggregator1["+index+"]."+ prop + "("+rv+")");
										
									}	
									
									if ((orig=="it1") || (orig=="it2")){
										logger.log( "eval('currentNode."+ prop + "("+rv+")');", "ndujaL",1 );
										eval("currentNode."+ prop + "("+rv+")");
										
									}
									if (orig=="tw") {
										logger.log( "eval('currentLeaf."+ prop + "("+rv+")');", "ndujaL",1 );
										eval("currentLeaf."+ prop + "("+rv+")");
										
									}
								}
								catch (exception){}		
								break;
							default:
								break;
						}
					}
					catch( exception )
					{
						logger.log( "//Exception in fuzzing attributes for element"+ elem, "ndujaL",1 );
					}
			}	
		}
		function spray() {
			for(S="\u4545",k=[],y=0;y++<65;)y<20?S+=S:k[y]=[S.substr(22)+"\u4545\u4545"].join("")
			
		}	
		
		
	</script>
	
</head>

<body  onload="step1()">

</body>

</html>
